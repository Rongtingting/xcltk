## XClone Preprocessing

XClone takes three matrices of haploblocks as input: allele-specific
AD and DP matrices and the other is the total read depth matrix of the blocks
for each cell. XClone preprocessing pipeline is aimed to generate the three 
matrices from SAM/BAM/CRAM files. It includes several steps described below.

To use the pipeline, the Github repo should be cloned firstly.

```shell
git clone https://github.com/hxj5/xcltk.git
```

### Dependencies

**Softwares**

All tools below should be added to system search path.

- [bcftools](https://github.com/samtools/bcftools)
- [bgzip or htslib](https://github.com/samtools/htslib)
- [cellsnp-lite](https://github.com/single-cell-genetics/cellsnp-lite)
- [LiftOver](https://genome-store.ucsc.edu/)
- [python](https://www.python.org/)
- [samtools](https://github.com/samtools/samtools)
- [xcltk](https://github.com/hxj5/xcltk)

**Files**

- [hg19 fasta](https://imputation.sanger.ac.uk/?resources=1) from Sanger Imputation 
  Server. Download from link 
  ftp://ftp.1000genomes.ebi.ac.uk/vol1/ftp/technical/reference/human_g1k_v37.fasta.gz

### BAF Part

The two allele-specific AD and DP matrices mentioned above would be refered to as
BAF (B-Allele Frequency) matrices. It takes several steps to get the 
BAF matrices.

#### BAF Pre-Imputation

The first step is pre-imputation. Germline SNPs would be called from 
SAM/BAM/CRAM file and saved as VCF file, which would be processed and only 
heterozygous SNPs would be used as input of the next step 
[Sanger Imputation][Sanger Server]. 

Quite a few softwares and some auxiliary datasets should be installed or downloaded 
before running this step. The required resources are specified in a 
[configure file][baf_pre_impute config]. It's recommended to make a copy of the configure 
file and then modify the new copy instead of modifying the original file. 

To run this step, use the script `baf_pre_impute.sh` in `preprocess/baf_pre_impute`
directory with proper settings. All possible settings could be found with the 
`-h` option,

```shell
cd preprocess/baf_pre_impute
./baf_pre_impute.sh -h
```

#### BAF Imputation (or Phasing only)

The VCF generated from previous step would be used for phasing or imputation on 
[Sanger Imputation Server][Sanger Server]. There's a comprehensive introduction to
this step at [here][Sanger Wiki].

#### BAF pre-pileup

The VCF file outputted by Sanger Imputation Server needs to be processed before used for pileuping. 

Similar to the Pre-Imputation step, this step also has a [configure file][baf_pre_pileup config] 
that specifies the required softwares and datasets. Still, Copy-and-Modify is recommended.

To run this step, use the script `baf_pre_pileup.sh` in `preprocess/baf_post_impute` 
directory with proper settings. All possible settings could be found with the `-h` option,

```shell
cd preprocess/baf_post_impute
./baf_pre_pileup.sh -h
```

#### BAF Pileup

Pileuping is aimed to extract variant information, mainly read depth of REF and 
ALT alleles, from SAM/BAM/CRAM file for each cell.

To run this step, the [configure file][baf_pileup config] should be provided and then use 
the script `baf_pileup.sh` in `preprocess/baf_post_impute` directory with proper settings. 
The script simply wraps cellsnp-lite and xcltk pileup. All possible settings could be 
found with the `-h` option,

```shell
cd preprocess/baf_post_impute
./baf_pileup.sh -h
```

Alternatively, you could use other pileup tools for this step.

#### BAF Phasing SNP

The allele-specific read depth of each variant for each cell, i.e. the AD and DP 
matrices created in previous steps, should be phased into each self-defined blocks. 
The blocks could be segments of even size that distribute uniformly along the 
genome or other feature blocks.

To run this step, simply use the `xcltk phase_snp` command with proper settings.

### RDR Part

The total read depth matrix of each block for each cell, refered to as RDR matrix,
could be found in the output of `cellranger count`, or alternatively could be 
generated by `xcltk basefc` command with proper settings.

[baf_pre_impute config]: https://github.com/hxj5/xcltk/blob/master/preprocess/baf_pre_impute/baf_pre_impute.cfg
[Sanger Server]: https://imputation.sanger.ac.uk/
[Sanger Wiki]: https://imputation.sanger.ac.uk/?instructions=1
[baf_pre_pileup config]: https://github.com/hxj5/xcltk/blob/master/preprocess/baf_post_impute/baf_pre_pileup.cfg
[baf_pileup config]: https://github.com/hxj5/xcltk/blob/master/preprocess/baf_post_impute/baf_pileup.cfg

